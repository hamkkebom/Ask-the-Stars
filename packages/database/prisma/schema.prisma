// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ì‚¬ìš©ì ê´€ë ¨ ëª¨ë¸
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String    @map("password")
  phone         String?
  role          UserRole  @default(STAR)
  profileImage  String?   @map("profile_image")
  bio           String?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  ownedProjects      Project[]           @relation("ProjectOwner")
  assignedProjects   Project[]           @relation("ProjectAssignees")
  submissions        Submission[]
  feedbacks          Feedback[]
  settlements        Settlement[]
  createdRequests    ProjectRequest[]    @relation("RequestCreator")
  assignments        ProjectAssignment[]

  enrollments        Enrollment[]
  posts              Post[]
  managedCounselors  Counselor[] // Counselors managed by this Agency User

  @@map("users")
}

enum UserRole {
  ADMIN              // ìŠˆí¼ ê´€ë¦¬ì
  MOON_MANAGER       // ë‹¬ ê´€ë¦¬ì (í†µí•©)
  MOON_ADVERTISING   // ê´‘ê³  ê´€ë¦¬ì
  MOON_FEEDBACK      // í”¼ë“œë°± ê´€ë¦¬ì
  MOON_SETTLEMENT    // ì •ì‚° ê´€ë¦¬ì
  STAR               // ìŠ¤íƒ€ (ì˜ìƒ ì œì‘ì)
  COUNSELOR          // ìƒë‹´ì‚¬ (í”¼ë“œë°± ì œê³µì)
}

// ==========================================
// ì œì‘ìš”ì²­ ê²Œì‹œíŒ ëª¨ë¸ (FINAL_SUMMARY ê¸°ë°˜)
// ==========================================

model ProjectRequest {
  id              String              @id @default(cuid())
  title           String
  description     String?
  categories      String[]            // ë¸Œëœë“œ/ì½”ë„ˆ/ë“±ê¸‰/ê³ ë¯¼/ì‹œê¸°
  deadline        DateTime
  assignmentType  AssignmentType      @default(MULTIPLE) @map("assignment_type")
  maxAssignees    Int                 @default(3) @map("max_assignees")
  currentAssignees Int                @default(0) @map("current_assignees")
  status          RequestStatus       @default(OPEN)
  estimatedBudget Decimal?            @db.Decimal(12, 2) @map("estimated_budget")
  requirements    String?             // ì œì‘ ê°€ì´ë“œë¼ì¸
  referenceUrls   String[]            @map("reference_urls")
  targetCounselorId String?           @map("target_counselor_id")
  createdById     String              @map("created_by_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  createdBy       User                @relation("RequestCreator", fields: [createdById], references: [id])
  assignments     ProjectAssignment[]

  @@map("project_requests")
}

enum AssignmentType {
  SINGLE    // ë…ì  (1ëª…ë§Œ)
  MULTIPLE  // ì¤‘ë³µ (ì—¬ëŸ¬ ëª…)
}

enum RequestStatus {
  OPEN      // ëª¨ì§‘ ì¤‘
  FULL      // ì •ì› ë§ˆê°
  CLOSED    // ë§ˆê°
  CANCELLED // ì·¨ì†Œë¨
}

// ==========================================
// í”„ë¦¬ëœì„œ ìˆ˜ë½ ë‚´ì—­
// ==========================================

model ProjectAssignment {
  id              String            @id @default(cuid())
  requestId       String            @map("request_id")
  freelancerId    String            @map("freelancer_id")
  acceptedAt      DateTime          @default(now()) @map("accepted_at")
  status          AssignmentStatus  @default(ACCEPTED)
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  request         ProjectRequest    @relation(fields: [requestId], references: [id], onDelete: Cascade)
  freelancer      User              @relation(fields: [freelancerId], references: [id])
  submissions     Submission[]

  @@unique([requestId, freelancerId])
  @@map("project_assignments")
}

enum AssignmentStatus {
  ACCEPTED    // ìˆ˜ë½ë¨
  IN_PROGRESS // ì§„í–‰ì¤‘
  SUBMITTED   // ì œì¶œì™„ë£Œ
  COMPLETED   // ì™„ë£Œ
  CANCELLED   // ì·¨ì†Œ
}

// ==========================================
// í”„ë¡œì íŠ¸ ê´€ë ¨ ëª¨ë¸ (ê¸°ì¡´ ìœ ì§€)
// ==========================================

model Project {
  id          String        @id @default(cuid())
  projectNo   Int?          @unique @map("project_no") // From Airtable
  title       String
  description String?
  lyrics      String?       @db.Text
  status      ProjectStatus @default(DRAFT)
  deadline    DateTime?
  budget      Decimal?      @db.Decimal(12, 2)
  startedAt   DateTime?     @map("started_at")

  ownerId     String        @map("owner_id")
  categoryId  String?       @map("category_id")
  counselorId String?       @map("counselor_id")
  channelId   String?       @map("channel_id")

  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  owner       User          @relation("ProjectOwner", fields: [ownerId], references: [id])
  assignees   User[]        @relation("ProjectAssignees")
  submissions Submission[]

  category    Category?     @relation(fields: [categoryId], references: [id])
  counselor   Counselor?    @relation(fields: [counselorId], references: [id])
  channel     Channel?      @relation(fields: [channelId], references: [id])
  videos      Video[]

  @@map("projects")
}

enum ProjectStatus {
  DRAFT           // ì´ˆì•ˆ
  PENDING         // ì˜ë¢° ëŒ€ê¸°
  MATCHING        // í”„ë¦¬ëœì„œ ë§¤ì¹­ ì¤‘
  IN_PROGRESS     // ì§„í–‰ì¤‘
  REVIEW          // ê²€í† ì¤‘
  REVISION        // ìˆ˜ì • ìš”ì²­
  COMPLETED       // ì™„ë£Œ
  CANCELLED       // ì·¨ì†Œë¨
}

// ==========================================
// ì œì¶œë¬¼ ê´€ë ¨ ëª¨ë¸ (ë‹¤ì¤‘ ë²„ì „ ì§€ì› ì¶”ê°€)
// ==========================================

model Submission {
  id            String           @id @default(cuid())
  projectId     String?          @map("project_id")
  assignmentId  String?          @map("assignment_id")  // NEW: ì œì‘ìš”ì²­ ì—°ê²°
  userId        String           @map("user_id")

  // ë‹¤ì¤‘ ë²„ì „ ì§€ì› (1~5ê°œ) â­
  versionSlot   Int              @default(1) @map("version_slot")  // 1~5
  versionTitle  String?          @map("version_title")  // "ê²½ì¾Œí•œ í†¤"
  version       Int              @default(1)            // v1.0 â†’ 1, v1.1 â†’ 2...

  videoUrl      String           @map("video_url")
  fileKey       String?          @map("file_key")  // R2 key
  duration      Int?             // ì˜ìƒ ê¸¸ì´ (ì´ˆ)
  thumbnailUrl  String?          @map("thumbnail_url")
  streamUid     String?          @map("stream_uid")
  status        SubmissionStatus @default(PENDING)
  notes         String?
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  // Relations
  project       Project?          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignment    ProjectAssignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user          User              @relation(fields: [userId], references: [id])
  feedbacks     Feedback[]

  @@unique([assignmentId, versionSlot])  // í•œ ìˆ˜ë½ë‹¹ ë²„ì „ìŠ¬ë¡¯ 1ê°œ
  @@map("submissions")
}

enum SubmissionStatus {
  PENDING     // ëŒ€ê¸°ì¤‘
  IN_REVIEW   // ê²€í† ì¤‘
  APPROVED    // ìŠ¹ì¸ë¨
  REJECTED    // ë°˜ë ¤ë¨
  REVISED     // ìˆ˜ì •ìš”ì²­
}

// ==========================================
// í”¼ë“œë°± ê´€ë ¨ ëª¨ë¸ (íƒ€ì„ìŠ¤íƒ¬í”„ ë²”ìœ„ ì¶”ê°€)
// ==========================================

model Feedback {
  id           String           @id @default(cuid())
  submissionId String           @map("submission_id")
  userId       String           @map("user_id")
  startTime    Float?           @map("start_time")  // ì‹œì‘ ì‹œê°„ (ì´ˆ)
  endTime      Float?           @map("end_time")    // ì¢…ë£Œ ì‹œê°„ (ì´ˆ)
  timestamp    Float?           // ë‹¨ì¼ íƒ€ì„ìŠ¤íƒ¬í”„ (í•˜ìœ„ í˜¸í™˜)
  feedbackType String?          @map("feedback_type")  // ìë§‰/BGM/ì»·í¸ì§‘/ìƒ‰ë³´ì •
  content      String
  priority     FeedbackPriority @default(NORMAL)
  status       FeedbackStatus   @default(PENDING)
  annotations  Json?            // í™”ë©´ ë§ˆí‚¹ ë°ì´í„°
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  // Relations
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id])

  @@map("feedbacks")
}

enum FeedbackPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum FeedbackStatus {
  PENDING    // ëŒ€ê¸°ì¤‘
  RESOLVED   // í•´ê²°ë¨
  WONTFIX    // ìˆ˜ì •ì•ˆí•¨
}

// ==========================================
// ì •ì‚° ê´€ë ¨ ëª¨ë¸ (1ì°¨/2ì°¨ ì •ì‚° êµ¬ë¶„ ì¶”ê°€)
// ==========================================

model Settlement {
  id            String           @id @default(cuid())
  userId        String           @map("user_id")
  submissionId  String?          @map("submission_id")  // ì—°ê²°ëœ ì œì¶œë¬¼
  amount        Decimal          @db.Decimal(12, 2)
  type          SettlementType
  settlementRound SettlementRound? @map("settlement_round")  // 1ì°¨/2ì°¨
  status        SettlementStatus @default(PENDING)
  description   String?
  quarterYear   Int?             @map("quarter_year")   // 2026
  quarterNumber Int?             @map("quarter_number") // 1, 2, 3, 4
  processedAt   DateTime?        @map("processed_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  // Relations
  user          User @relation(fields: [userId], references: [id])

  @@map("settlements")
}

enum SettlementType {
  PAYOUT     // ì§€ê¸‰
  DEDUCTION  // ê³µì œ
  BONUS      // ë³´ë„ˆìŠ¤
}

enum SettlementRound {
  PRIMARY    // 1ì°¨ ì •ì‚° (ì œì‘ë¹„)
  SECONDARY  // 2ì°¨ ì •ì‚° (ì¸ì„¼í‹°ë¸Œ)
}

enum SettlementStatus {
  PENDING    // ëŒ€ê¸°ì¤‘
  PROCESSING // ì²˜ë¦¬ì¤‘
  COMPLETED  // ì™„ë£Œ
  FAILED     // ì‹¤íŒ¨
}

// ==========================================
// ê´‘ê³  ìº í˜ì¸ ëª¨ë¸ (ì‹ ê·œ)
// ==========================================

model Campaign {
  id              String          @id @default(cuid())
  name            String
  submissionId    String?         @map("submission_id")
  platform        String[]        // YouTube, Instagram, Facebook
  budget          Decimal         @db.Decimal(12, 2)
  startDate       DateTime        @map("start_date")
  endDate         DateTime        @map("end_date")
  targetAudience  Json?           @map("target_audience")
  status          CampaignStatus  @default(DRAFT)

  // ì„±ê³¼ ì§€í‘œ
  views           Int             @default(0)
  clicks          Int             @default(0)
  conversions     Int             @default(0)

  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT       // ì´ˆì•ˆ
  SCHEDULED   // ì˜ˆì •
  ACTIVE      // ì§„í–‰ì¤‘
  PAUSED      // ì¼ì‹œì¤‘ì§€
  COMPLETED   // ì™„ë£Œ
  CANCELLED   // ì·¨ì†Œ
}

// ==========================================
// ì„¤ëª…íšŒ ì‹ ì²­ì (Leads) ëª¨ë¸ (ì‹ ê·œ)
// ==========================================

model Lead {
  id              String          @id @default(cuid())
  name            String
  email           String
  phone           String?
  channel         String?         // ìœ ì… ê²½ë¡œ (ì¸ìŠ¤íƒ€, ì§€ì¸ ë“±)
  interest        String?         // ê´€ì‹¬ ë¶„ì•¼ (ê¸°ì´ˆë°˜, ì‹¬í™”ë°˜ ë“±)
  isAttended      Boolean         @default(false) @map("is_attended")
  notes           String?
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@map("leads")
}
// ==========================================
// ì˜ìƒ ìì‚° ê´€ë ¨ ëª¨ë¸ (Video Asset Management)
// ==========================================

model Video {
  id                 String      @id @default(uuid())
  airtableId         String?     @unique @map("airtable_id")
  projectId          String      @map("project_id")
  makerId            String?     @map("maker_id")

  versionLabel       String      @map("version_label") // e.g. "v1.0"
  versionNumber      String?     @map("version_number")
  status             VideoStatus @default(DRAFT)
  isRevised          Boolean     @default(false) @map("is_revised")
  isAdminConfirmed   Boolean     @default(false) @map("is_admin_confirmed")

  feedback           String?     @db.Text
  internalComment    String?     @db.Text @map("internal_comment")
  completedAt        DateTime?   @map("completed_at")

  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  // Relations
  project            Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  maker              Maker?      @relation(fields: [makerId], references: [id])
  technicalSpec      VideoTechnicalSpec?
  eventLogs          VideoEventLog[]

  @@map("videos")
}

enum VideoStatus {
  DRAFT
  PENDING
  APPROVED
  FINAL
}

model VideoTechnicalSpec {
  video_id          String   @id @map("video_id")

  filename          String   @map("filename")
  format            String?
  fileSize          BigInt?  @map("file_size")
  duration          Float?
  overallBitrate    Int?     @map("overall_bitrate")

  videoCodec        String?  @map("video_codec")
  width             Int?
  height            Int?
  fps               Float?
  aspectRatio       String?  @map("aspect_ratio")
  pixelFormat       String?  @map("pixel_format")

  audioCodec        String?  @map("audio_codec")
  audioChannels     Int?     @map("audio_channels")
  sampleRate        Int?     @map("sample_rate")

  originalUrl       String?  @db.Text @map("original_url")
  thumbnailUrl      String?  @map("thumbnail_url")
  thumbnailAlt      String?  @map("thumbnail_alt")
  thumbnailWidth    Int?     @map("thumbnail_width")
  thumbnailHeight   Int?     @map("thumbnail_height")

  r2Key             String   @map("r2_key")
  r2KeyThumbAvif    String?  @map("r2_key_thumb_avif")
  r2KeyThumbWebp    String?  @map("r2_key_thumb_webp")
  r2KeyThumbOg      String?  @map("r2_key_thumb_og")
  streamUid         String?  @map("stream_uid")

  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  video             Video    @relation(fields: [video_id], references: [id], onDelete: Cascade)

  @@map("video_technical_specs")
}

model VideoEventLog {
  id          String   @id @default(cuid())
  videoId     String   @map("video_id")
  eventType   String   @map("event_type")
  occurredAt  DateTime @default(now()) @map("occurred_at")
  metadata    Json?

  // Relations
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("video_event_logs")
}

// ==========================================
// ë©”íƒ€ë°ì´í„° ëª¨ë¸ (Metadata Lookups)
// ==========================================

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  projects    Project[]
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("categories")
}

// --- Counselors (Offline 500) ---
model Counselor {
  id          String   @id @default(cuid())

  // 1. Basic Identity
  name        String
  displayName String?  @map("display_name") // í˜¸ëª…
  shortId     String?  @unique @map("short_id") // ìƒë‹´ì‚¬ID (Legacy/Airtable)
  phone       String?
  email       String?

  // 2. Profile & Content
  profileImageUrl String? @map("profile_image_url") // ì´ë¯¸ì§€ ì£¼ì†Œ/ì‚¬ì§„
  introduction    String? @db.Text // ì†Œê°œê¸€
  career          String? @db.Text // ê²½ë ¥ì‚¬í•­
  notice          String? @db.Text // ê³µì§€ì‚¬í•­

  // 3. Classification
  majorCategories String[] @map("major_categories") // ì£¼ìš”ìƒë‹´ë¶„ì•¼
  tags            String[] // í•´ì‹œíƒœê·¸
  category        String?  // ë¶„ë¥˜
  region          String?
  specialty       String?  // Removed or kept as alias? legacy logic. Keeping for safety if used elsewhere.

  // 4. Flags (Boolean)
  isKokkok        Boolean  @default(false) @map("is_kokkok") // ì½•ì½•ìƒë‹´
  isDonation      Boolean  @default(false) @map("is_donation") // ê¸°ë¶€ìƒë‹´
  isGift          Boolean  @default(false) @map("is_gift") // ì„ ë¬¼ìƒë‹´
  hasRateIncrease Boolean  @default(false) @map("has_rate_increase") // ì¸ìƒì°¸ì—¬
  attendedSession Boolean  @default(false) @map("attended_session") // ì„¤ëª…íšŒì°¸ì„
  isAdApplied     Boolean  @default(false) @map("is_ad_applied") // ê´‘ê³ ì‹ ì²­

  // 5. Metrics (Fees & Times)
  prevFee             Decimal? @map("prev_fee") @db.Decimal(12, 2) // ì´ì „ ì´ìš©ë£Œ
  increasedFee        Decimal? @map("increased_fee") @db.Decimal(12, 2) // ì¸ìƒ ì´ìš©ë£Œ

  targetTimeCurrent   Int?     @map("target_time_current") // í˜„ì¬ ëª©í‘œì‹œê°„
  targetTimePrev      Int?     @map("target_time_prev") // ì´ì „ ëª©í‘œì‹œê°„
  targetTimeChallenge Int?     @map("target_time_challenge") // ë„ì „ ëª©í‘œì‹œê°„
  waitingTime         Int?     @map("waiting_time") // ëŒ€ê¸°ì‹œê°„ (ê´€ë¦¬íŒ€ ì¶”ê°€)

  status      String   @default("ACTIVE") // ìƒíƒœ

  // Management
  agencyId    String?  @map("agency_id")
  agency      User?    @relation(fields: [agencyId], references: [id])

  projects    Project[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("counselors")
}

model Channel {
  id        String    @id @default(cuid())
  name      String    @unique
  platform  String?   @default("youtube")
  url       String?
  projects  Project[]
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("channels")
}

model Maker {
  id          String    @id @default(cuid())
  name        String    @unique
  role        String?
  authUserId  String?   @map("auth_user_id")
  videos      Video[]
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("makers")
}

// ==========================================
// LMS (Learning Management System) Models ğŸ†•
// ==========================================

model Course {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?  @db.Text
  level       String   // BASIC, ADVANCED
  price       Decimal  @default(0) @db.Decimal(12, 2)
  isPublished Boolean  @default(false) @map("is_published")
  thumbnailUrl String? @map("thumbnail_url")

  modules     Module[]
  enrollments Enrollment[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("courses")
}

model Module {
  id        String   @id @default(cuid())
  title     String
  order     Int
  courseId  String   @map("course_id")
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons   Lesson[]

  @@map("modules")
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  type        String   // VIDEO, TEXT, QUIZ
  content     String?  // Text content or JSON
  videoR2Key  String?  @map("video_r2_key") // R2 Key for video
  duration    Int?     // Seconds
  order       Int
  moduleId    String   @map("module_id")
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("lessons")
}

model Enrollment {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  courseId  String   @map("course_id")
  status    String   // ACTIVE, COMPLETED, CANCELLED
  progress  Int      @default(0) // %

  user      User     @relation(fields: [userId], references: [id])
  course    Course   @relation(fields: [courseId], references: [id])

  enrolledAt DateTime @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")

  @@unique([userId, courseId])
  @@map("enrollments")
}

// ==========================================
// Content Management (News/Notice) ğŸ†•
// ==========================================

model Post {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  excerpt     String?
  type        PostType @default(NEWS)
  thumbnailUrl String? @map("thumbnail_url")
  isPublished Boolean  @default(true) @map("is_published")
  publishedAt DateTime @default(now()) @map("published_at")

  authorId    String?  @map("author_id")
  author      User?    @relation(fields: [authorId], references: [id])

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("posts")
}

enum PostType {
  NEWS
  NOTICE
  EVENT
  CASE_STUDY
}
