// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 사용자 관련 모델
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String    @map("password")
  phone         String?
  role          UserRole  @default(STAR)
  profileImage  String?   @map("profile_image")
  bio           String?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  ownedProjects      Project[]           @relation("ProjectOwner")
  assignedProjects   Project[]           @relation("ProjectAssignees")
  submissions        Submission[]
  feedbacks          Feedback[]
  settlements        Settlement[]
  createdRequests    ProjectRequest[]    @relation("RequestCreator")
  assignments        ProjectAssignment[]

  @@map("users")
}

enum UserRole {
  ADMIN              // 슈퍼 관리자
  MOON_MANAGER       // 달 관리자 (통합)
  MOON_ADVERTISING   // 광고 관리자
  MOON_FEEDBACK      // 피드백 관리자
  MOON_SETTLEMENT    // 정산 관리자
  STAR               // 스타 (영상 제작자)
  COUNSELOR          // 상담사 (피드백 제공자)
}

// ==========================================
// 제작요청 게시판 모델 (FINAL_SUMMARY 기반)
// ==========================================

model ProjectRequest {
  id              String              @id @default(cuid())
  title           String
  description     String?
  categories      String[]            // 브랜드/코너/등급/고민/시기
  deadline        DateTime
  assignmentType  AssignmentType      @default(MULTIPLE) @map("assignment_type")
  maxAssignees    Int                 @default(3) @map("max_assignees")
  currentAssignees Int                @default(0) @map("current_assignees")
  status          RequestStatus       @default(OPEN)
  estimatedBudget Decimal?            @db.Decimal(12, 2) @map("estimated_budget")
  requirements    String?             // 제작 가이드라인
  referenceUrls   String[]            @map("reference_urls")
  targetCounselorId String?           @map("target_counselor_id")
  createdById     String              @map("created_by_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  createdBy       User                @relation("RequestCreator", fields: [createdById], references: [id])
  assignments     ProjectAssignment[]

  @@map("project_requests")
}

enum AssignmentType {
  SINGLE    // 독점 (1명만)
  MULTIPLE  // 중복 (여러 명)
}

enum RequestStatus {
  OPEN      // 모집 중
  FULL      // 정원 마감
  CLOSED    // 마감
  CANCELLED // 취소됨
}

// ==========================================
// 프리랜서 수락 내역
// ==========================================

model ProjectAssignment {
  id              String            @id @default(cuid())
  requestId       String            @map("request_id")
  freelancerId    String            @map("freelancer_id")
  acceptedAt      DateTime          @default(now()) @map("accepted_at")
  status          AssignmentStatus  @default(ACCEPTED)
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  request         ProjectRequest    @relation(fields: [requestId], references: [id], onDelete: Cascade)
  freelancer      User              @relation(fields: [freelancerId], references: [id])
  submissions     Submission[]

  @@unique([requestId, freelancerId])
  @@map("project_assignments")
}

enum AssignmentStatus {
  ACCEPTED    // 수락됨
  IN_PROGRESS // 진행중
  SUBMITTED   // 제출완료
  COMPLETED   // 완료
  CANCELLED   // 취소
}

// ==========================================
// 프로젝트 관련 모델 (기존 유지)
// ==========================================

model Project {
  id          String        @id @default(cuid())
  projectNo   Int?          @unique @map("project_no") // From Airtable
  title       String
  description String?
  lyrics      String?       @db.Text
  status      ProjectStatus @default(DRAFT)
  deadline    DateTime?
  budget      Decimal?      @db.Decimal(12, 2)
  startedAt   DateTime?     @map("started_at")

  ownerId     String        @map("owner_id")
  categoryId  String?       @map("category_id")
  counselorId String?       @map("counselor_id")
  channelId   String?       @map("channel_id")

  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  owner       User          @relation("ProjectOwner", fields: [ownerId], references: [id])
  assignees   User[]        @relation("ProjectAssignees")
  submissions Submission[]

  category    Category?     @relation(fields: [categoryId], references: [id])
  counselor   Counselor?    @relation(fields: [counselorId], references: [id])
  channel     Channel?      @relation(fields: [channelId], references: [id])
  videos      Video[]

  @@map("projects")
}

enum ProjectStatus {
  DRAFT           // 초안
  PENDING         // 의뢰 대기
  MATCHING        // 프리랜서 매칭 중
  IN_PROGRESS     // 진행중
  REVIEW          // 검토중
  REVISION        // 수정 요청
  COMPLETED       // 완료
  CANCELLED       // 취소됨
}

// ==========================================
// 제출물 관련 모델 (다중 버전 지원 추가)
// ==========================================

model Submission {
  id            String           @id @default(cuid())
  projectId     String?          @map("project_id")
  assignmentId  String?          @map("assignment_id")  // NEW: 제작요청 연결
  userId        String           @map("user_id")

  // 다중 버전 지원 (1~5개) ⭐
  versionSlot   Int              @default(1) @map("version_slot")  // 1~5
  versionTitle  String?          @map("version_title")  // "경쾌한 톤"
  version       Int              @default(1)            // v1.0 → 1, v1.1 → 2...

  videoUrl      String           @map("video_url")
  fileKey       String?          @map("file_key")  // R2 key
  duration      Int?             // 영상 길이 (초)
  thumbnailUrl  String?          @map("thumbnail_url")
  status        SubmissionStatus @default(PENDING)
  notes         String?
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  // Relations
  project       Project?          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignment    ProjectAssignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user          User              @relation(fields: [userId], references: [id])
  feedbacks     Feedback[]

  @@unique([assignmentId, versionSlot])  // 한 수락당 버전슬롯 1개
  @@map("submissions")
}

enum SubmissionStatus {
  PENDING     // 대기중
  IN_REVIEW   // 검토중
  APPROVED    // 승인됨
  REJECTED    // 반려됨
  REVISED     // 수정요청
}

// ==========================================
// 피드백 관련 모델 (타임스탬프 범위 추가)
// ==========================================

model Feedback {
  id           String           @id @default(cuid())
  submissionId String           @map("submission_id")
  userId       String           @map("user_id")
  startTime    Float?           @map("start_time")  // 시작 시간 (초)
  endTime      Float?           @map("end_time")    // 종료 시간 (초)
  timestamp    Float?           // 단일 타임스탬프 (하위 호환)
  feedbackType String?          @map("feedback_type")  // 자막/BGM/컷편집/색보정
  content      String
  priority     FeedbackPriority @default(NORMAL)
  status       FeedbackStatus   @default(PENDING)
  annotations  Json?            // 화면 마킹 데이터
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  // Relations
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id])

  @@map("feedbacks")
}

enum FeedbackPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum FeedbackStatus {
  PENDING    // 대기중
  RESOLVED   // 해결됨
  WONTFIX    // 수정안함
}

// ==========================================
// 정산 관련 모델 (1차/2차 정산 구분 추가)
// ==========================================

model Settlement {
  id            String           @id @default(cuid())
  userId        String           @map("user_id")
  submissionId  String?          @map("submission_id")  // 연결된 제출물
  amount        Decimal          @db.Decimal(12, 2)
  type          SettlementType
  settlementRound SettlementRound? @map("settlement_round")  // 1차/2차
  status        SettlementStatus @default(PENDING)
  description   String?
  quarterYear   Int?             @map("quarter_year")   // 2026
  quarterNumber Int?             @map("quarter_number") // 1, 2, 3, 4
  processedAt   DateTime?        @map("processed_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  // Relations
  user          User @relation(fields: [userId], references: [id])

  @@map("settlements")
}

enum SettlementType {
  PAYOUT     // 지급
  DEDUCTION  // 공제
  BONUS      // 보너스
}

enum SettlementRound {
  PRIMARY    // 1차 정산 (제작비)
  SECONDARY  // 2차 정산 (인센티브)
}

enum SettlementStatus {
  PENDING    // 대기중
  PROCESSING // 처리중
  COMPLETED  // 완료
  FAILED     // 실패
}

// ==========================================
// 광고 캠페인 모델 (신규)
// ==========================================

model Campaign {
  id              String          @id @default(cuid())
  name            String
  submissionId    String?         @map("submission_id")
  platform        String[]        // YouTube, Instagram, Facebook
  budget          Decimal         @db.Decimal(12, 2)
  startDate       DateTime        @map("start_date")
  endDate         DateTime        @map("end_date")
  targetAudience  Json?           @map("target_audience")
  status          CampaignStatus  @default(DRAFT)

  // 성과 지표
  views           Int             @default(0)
  clicks          Int             @default(0)
  conversions     Int             @default(0)

  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT       // 초안
  SCHEDULED   // 예정
  ACTIVE      // 진행중
  PAUSED      // 일시중지
  COMPLETED   // 완료
  CANCELLED   // 취소
}

// ==========================================
// 설명회 신청자 (Leads) 모델 (신규)
// ==========================================

model Lead {
  id              String          @id @default(cuid())
  name            String
  email           String
  phone           String?
  channel         String?         // 유입 경로 (인스타, 지인 등)
  interest        String?         // 관심 분야 (기초반, 심화반 등)
  isAttended      Boolean         @default(false) @map("is_attended")
  notes           String?
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@map("leads")
}
// ==========================================
// 영상 자산 관련 모델 (Video Asset Management)
// ==========================================

model Video {
  id                 String      @id @default(uuid())
  airtableId         String?     @unique @map("airtable_id")
  projectId          String      @map("project_id")
  makerId            String?     @map("maker_id")

  versionLabel       String      @map("version_label") // e.g. "v1.0"
  versionNumber      String?     @map("version_number")
  status             VideoStatus @default(DRAFT)
  isRevised          Boolean     @default(false) @map("is_revised")
  isAdminConfirmed   Boolean     @default(false) @map("is_admin_confirmed")

  feedback           String?     @db.Text
  internalComment    String?     @db.Text @map("internal_comment")
  completedAt        DateTime?   @map("completed_at")

  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  // Relations
  project            Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  maker              Maker?      @relation(fields: [makerId], references: [id])
  technicalSpec      VideoTechnicalSpec?
  eventLogs          VideoEventLog[]

  @@map("videos")
}

enum VideoStatus {
  DRAFT
  PENDING
  APPROVED
  FINAL
}

model VideoTechnicalSpec {
  video_id          String   @id @map("video_id")

  filename          String   @map("filename")
  format            String?
  fileSize          BigInt?  @map("file_size")
  duration          Float?
  overallBitrate    Int?     @map("overall_bitrate")

  videoCodec        String?  @map("video_codec")
  width             Int?
  height            Int?
  fps               Float?
  aspectRatio       String?  @map("aspect_ratio")
  pixelFormat       String?  @map("pixel_format")

  audioCodec        String?  @map("audio_codec")
  audioChannels     Int?     @map("audio_channels")
  sampleRate        Int?     @map("sample_rate")

  originalUrl       String?  @db.Text @map("original_url")
  thumbnailUrl      String?  @map("thumbnail_url")
  thumbnailAlt      String?  @map("thumbnail_alt")
  thumbnailWidth    Int?     @map("thumbnail_width")
  thumbnailHeight   Int?     @map("thumbnail_height")

  r2Key             String   @map("r2_key")
  r2KeyThumbAvif    String?  @map("r2_key_thumb_avif")
  r2KeyThumbWebp    String?  @map("r2_key_thumb_webp")
  r2KeyThumbOg      String?  @map("r2_key_thumb_og")
  streamUid         String?  @map("stream_uid")

  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  video             Video    @relation(fields: [video_id], references: [id], onDelete: Cascade)

  @@map("video_technical_specs")
}

model VideoEventLog {
  id          String   @id @default(cuid())
  videoId     String   @map("video_id")
  eventType   String   @map("event_type")
  occurredAt  DateTime @default(now()) @map("occurred_at")
  metadata    Json?

  // Relations
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("video_event_logs")
}

// ==========================================
// 메타데이터 모델 (Metadata Lookups)
// ==========================================

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  projects    Project[]
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("categories")
}

model Counselor {
  id        String    @id @default(cuid())
  name      String    @unique
  email     String?
  projects  Project[]
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("counselors")
}

model Channel {
  id        String    @id @default(cuid())
  name      String    @unique
  platform  String?   @default("youtube")
  url       String?
  projects  Project[]
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("channels")
}

model Maker {
  id          String    @id @default(cuid())
  name        String    @unique
  role        String?
  authUserId  String?   @map("auth_user_id")
  videos      Video[]
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("makers")
}
