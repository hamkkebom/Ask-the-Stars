# ROBUST SINGLE STAGE BUILD
FROM node:22

RUN npm install -g pnpm@9.15.2
RUN apt-get update -y && apt-get install -y openssl

WORKDIR /app

# Copy ALL files
COPY . .

# Install dependencies
RUN pnpm install --frozen-lockfile

# Generate Prisma
RUN npx prisma generate --schema=packages/database/prisma/schema.prisma

# Build API
RUN pnpm --filter @ask-the-stars/api build

ENV NODE_ENV=production
ENV PORT=8080
EXPOSE 8080

WORKDIR /app/apps/api

# Robust entrypoint: find main.js in dist
CMD ["sh", "-c", "node $(find dist -name main.js | head -n 1)"]
